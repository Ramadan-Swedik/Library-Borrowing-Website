<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reports & Analytics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .card h6 { font-weight:700; }
    .kpi { font-size:2rem; font-weight:800; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4 py-md-5">
    <header class="d-flex justify-content-between align-items-center mb-4">
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="admin.html"><i class="bi bi-arrow-left"></i> Back</a>
        <h2 class="fw-bold m-0">Reports & Analytics</h2>
      </div>
      <div>
        <button id="refresh" class="btn btn-outline-primary"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
      </div>
    </header>

    <!-- KPIs -->
    <section class="row g-3 mb-4" id="kpis"></section>

    <!-- Charts -->
    <div class="row g-3">
      <div class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6>Status Distribution</h6>
            <canvas id="statusChart" height="240"></canvas>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6>Registrations per Event</h6>
            <canvas id="eventChart" height="240"></canvas>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6>Registrations Over Time</h6>
            <canvas id="timeChart" height="240"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- utilities
    const getAll = () => JSON.parse(localStorage.getItem("participants")) || [];
    const by = (arr, key) => arr.reduce((m, x)=> (m[x[key]]=(m[x[key]]||0)+1, m), {});
    const fmt = (n)=> new Intl.NumberFormat().format(n);

    function renderKPIs(list){
      const approved = list.filter(p=>p.status==="Approved").length;
      const pending  = list.filter(p=>!p.status || p.status==="Pending").length;
      const rejected = list.filter(p=>p.status==="Rejected").length;
      const total    = list.length;

      const el = document.getElementById("kpis");
      el.innerHTML = `
        <div class="col-12 col-md-3"><div class="card shadow-sm"><div class="card-body">
          <div class="text-muted">Total</div><div class="kpi">${fmt(total)}</div>
        </div></div></div>
        <div class="col-12 col-md-3"><div class="card shadow-sm"><div class="card-body">
          <div class="text-muted">Approved</div><div class="kpi text-success">${fmt(approved)}</div>
        </div></div></div>
        <div class="col-12 col-md-3"><div class="card shadow-sm"><div class="card-body">
          <div class="text-muted">Pending</div><div class="kpi text-warning">${fmt(pending)}</div>
        </div></div></div>
        <div class="col-12 col-md-3"><div class="card shadow-sm"><div class="card-body">
          <div class="text-muted">Rejected</div><div class="kpi text-danger">${fmt(rejected)}</div>
        </div></div></div>
      `;
    }

    let statusChart, eventChart, timeChart;

    function renderCharts(list){
      // cleanup existing
      statusChart?.destroy(); eventChart?.destroy(); timeChart?.destroy();

      // Status distribution
      const sMap = by(list.map(p=>({status:p.status||"Pending"})), "status");
      const sLabels = Object.keys(sMap);
      const sData = Object.values(sMap);

      statusChart = new Chart(document.getElementById("statusChart"), {
        type: "doughnut",
        data: { labels: sLabels, datasets: [{ data: sData }] },
        options: { plugins: { legend: { position: "bottom" } } }
      });

      // Registrations per Event
      const eMap = by(list, "event");
      const eLabels = Object.keys(eMap);
      const eData = Object.values(eMap);

      eventChart = new Chart(document.getElementById("eventChart"), {
        type: "bar",
        data: { labels: eLabels, datasets: [{ data: eData }] },
        options: { plugins: { legend: { display:false } }, scales: { y: { beginAtZero:true, precision:0 } } }
      });

      // Registrations over time (by date)
      const tMap = list.reduce((m,p)=>{ if(p.date){ m[p.date]=(m[p.date]||0)+1; } return m; }, {});
      const tLabels = Object.keys(tMap).sort();
      const tData = tLabels.map(d=>tMap[d]);

      timeChart = new Chart(document.getElementById("timeChart"), {
        type: "line",
        data: { labels: tLabels, datasets: [{ data: tData, tension:.25, fill:false }] },
        options: { plugins: { legend: { display:false } }, scales: { y: { beginAtZero:true, precision:0 } } }
      });
    }

    function init(){
      const data = getAll();
      renderKPIs(data);
      renderCharts(data);
    }

    init();
    document.getElementById("refresh").addEventListener("click", init);
    window.addEventListener("storage", init);
  </script>
</body>
</html>
